name: Build Electron

on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            arch: x64
          - os: ubuntu-latest
            arch: arm64
          - os: windows-latest
            arch: x64
          - os: macos-latest
            arch: x64
          - os: macos-latest
            arch: arm64

    runs-on: ${{ matrix.os }}
    defaults:
      run:
        working-directory: app

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: app/package-lock.json

      # --- Icon generation ---
      - name: Install ImageMagick (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y imagemagick

      - name: Generate PNG icons from SVG (Linux)
        if: runner.os == 'Linux'
        run: |
          cd assets
          convert icon.svg -resize 512x512 icon.png
          mkdir -p icons
          for size in 16 32 48 128 256 512; do
            convert icon.svg -resize ${size}x${size} icons/${size}x${size}.png
          done

      - name: Generate icon assets (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cd assets
          pip install Pillow==11.1.0
          python generate_icons.py

      - name: Generate PNG icons from SVG (macOS)
        if: runner.os == 'macOS'
        run: |
          cd assets
          # Generate PNGs from the committed icon.png (512x512 source)
          mkdir -p icons
          for size in 16 32 48 128 256 512; do
            sips -z $size $size icon.png --out icons/${size}x${size}.png
          done

      - name: Generate ICNS (macOS)
        if: runner.os == 'macOS'
        run: |
          cd assets
          mkdir -p icon.iconset
          for size in 16 32 48 128 256 512; do
            sips -z $size $size icon.png --out icon.iconset/icon_${size}x${size}.png
          done
          # Retina variants
          sips -z 32 32 icon.png --out icon.iconset/icon_16x16@2x.png
          sips -z 64 64 icon.png --out icon.iconset/icon_32x32@2x.png
          sips -z 256 256 icon.png --out icon.iconset/icon_128x128@2x.png
          sips -z 512 512 icon.png --out icon.iconset/icon_256x256@2x.png
          iconutil -c icns icon.iconset -o icon.icns
          rm -rf icon.iconset

      # --- Build ---
      - name: Install dependencies
        run: npm ci

      - name: Install MakerDMG (macOS)
        if: runner.os == 'macOS'
        run: npm install --save-dev @electron-forge/maker-dmg
        working-directory: app/packages/electron

      - name: Build shared
        run: npm run build:shared

      - name: Build frontend
        run: npm run build:frontend

      - name: Package Electron (${{ matrix.arch }})
        run: npm run build:electron -- --arch=${{ matrix.arch }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # --- Upload ---
      - name: Upload app artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gitgael-electron-${{ matrix.os }}-${{ matrix.arch }}
          path: app/packages/electron/out/make/**/*

      - name: Upload installer scripts
        if: runner.os == 'Linux' && matrix.arch == 'x64'
        uses: actions/upload-artifact@v4
        with:
          name: gitgael-installer-scripts
          path: |
            app/scripts/install.sh
            app/scripts/uninstall.sh
